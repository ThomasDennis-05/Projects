<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications - FastTrack</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1e40af;
            --secondary-color: #10b981;
            --secondary-dark: #059669;
            --accent-color: #f97316;
            --danger-color: #ef4444;
            --text-color: #1f2937;
            --text-light: #6b7280;
            --bg-color: #f3f4f6;
            --white: #ffffff;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: var(--white);
            padding: 1rem 2rem;
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        header .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        header h1 {
            margin: 0;
            font-size: 1.75rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        header .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        header .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--white);
        }

        nav {
            background-color: var(--white);
            box-shadow: var(--shadow-sm);
            padding: 0.75rem 2rem;
            z-index: 10;
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
        }

        .nav-links a {
            color: var(--text-color);
            text-decoration: none;
            font-size: 1rem;
            font-weight: 500;
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-sm);
            transition: var(--transition);
            position: relative;
        }

        .nav-links a:hover {
            color: var(--primary-color);
        }

        .nav-links a.active {
            color: var(--primary-color);
            font-weight: 600;
        }

        .nav-links a.active::after {
            content: '';
            position: absolute;
            bottom: -0.75rem;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 3px;
        }

        .main-container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 2rem;
            flex: 1;
        }

        .notifications-wrapper {
            background-color: var(--white);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .notifications-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }

        .notifications-header h2 {
            font-size: 1.5rem;
            color: var(--text-color);
        }

        .notification-card {
            background-color: var(--white);
            border: 1px solid #eee;
            border-left: 4px solid var(--primary-color);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            position: relative;
            margin-bottom: 1rem;
        }

        .notification-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .notification-card h3 {
            margin-bottom: 0.5rem;
            color: var(--text-color);
            font-size: 1.2rem;
        }

        .notification-details {
            margin-bottom: 1rem;
        }

        .notification-details p {
            margin-bottom: 0.25rem;
            font-size: 0.95rem;
        }

        .notification-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .btn {
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 0.5rem 1.25rem;
            border-radius: var(--radius-md);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
        }

        .btn-secondary:hover {
            background-color: var(--secondary-dark);
        }

        .btn-accent {
            background-color: var(--accent-color);
        }

        .btn-accent:hover {
            background-color: darkorange;
        }

        .btn-outline {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .btn-outline:hover {
            background-color: var(--primary-color);
            color: var(--white);
        }

        .loading {
            text-align: center;
            padding: 2rem 0;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 40px;
            height: 40px;
            margin: 0 auto 1rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-notifications {
            text-align: center;
            padding: 3rem;
            color: var(--text-light);
        }

        .no-notifications i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .footer {
            background-color: var(--white);
            padding: 1.5rem 2rem;
            margin-top: 2rem;
            text-align: center;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: white;
            padding: 20px;
            max-width: 800px;
            margin: 50px auto;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            height: 80vh;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #eee;
        }

        .close-btn {
            background: var(--danger-color);
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            cursor: pointer;
            border-radius: var(--radius-md);
        }

        .ambulance-list-modal {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding: 0.5rem;
            flex: 0 0 auto;
        }

        .ambulance-card {
            background: #f9f9f9;
            padding: 1rem;
            border-radius: var(--radius-md);
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ambulance-card h3 {
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .ambulance-card p {
            margin: 0.25rem 0;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .notify-btn {
            background: var(--accent-color);
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            cursor: pointer;
            border-radius: var(--radius-md);
        }

        .notify-btn:hover {
            background: darkorange;
        }

        /* Map styles */
        #map-container {
            flex: 1;
            margin-top: 1rem;
            border-radius: var(--radius-md);
            overflow: hidden;
            position: relative;
            min-height: 300px;
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: var(--radius-md);
        }

        .map-loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* Ambulance status indicators */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-available {
            background-color: var(--secondary-color);
        }

        .status-busy {
            background-color: var(--danger-color);
        }

        .status-en-route {
            background-color: var(--accent-color);
        }

        /* Ambulance accepted animation */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .ambulance-accepted {
            animation: pulse 1s infinite;
            border-left: 4px solid var(--secondary-color);
            background-color: rgba(16, 185, 129, 0.1);
        }

        .track-btn {
            background: var(--secondary-color);
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            cursor: pointer;
            border-radius: var(--radius-md);
        }

        .track-btn:hover {
            background: var(--secondary-dark);
        }

        /* Patient info box on map */
        .patient-info-box {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            z-index: 100;
            max-width: 250px;
        }

        .patient-info-box h4 {
            margin-bottom: 5px;
            color: var(--text-color);
        }

        .patient-info-box p {
            margin: 3px 0;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        /* Socket.io notification indicator */
        .socket-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            background: white;
            padding: 8px 12px;
            border-radius: 20px;
            box-shadow: var(--shadow-md);
            font-size: 0.85rem;
            z-index: 100;
        }

        .socket-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .socket-connected {
            background-color: var(--secondary-color);
        }

        .socket-disconnected {
            background-color: var(--danger-color);
        }

        /* Real-time notifications */
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            animation: pulse 1s infinite;
        }

        /* Status badges */
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            margin-left: 0.5rem;
        }

        .status-badge.pending {
            background-color: #f0f6ff;
            color: var(--primary-color);
        }

        .status-badge.assigned {
            background-color: #e6fff4;
            color: var(--secondary-color);
        }

        .status-badge.completed {
            background-color: #e9e9e9;
            color: var(--text-light);
        }

        .status-badge.notifying {
            background-color: #fff5e9;
            color: var(--accent-color);
        }

        /* Alert Message */
        .alert {
            padding: 1rem;
            border-radius: var(--radius-md);
            margin-bottom: 1.5rem;
            display: none;
        }
        
        .alert-success {
            background-color: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            color: var(--secondary-dark);
        }
        
        .alert-error {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: var(--danger-color);
        }

        /* Modal actions */
        .modal-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }
    </style>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
</head>
<body>
<header>
    <div class="logo">
        <i class="fas fa-ambulance"></i>
        <h1>FastTrack</h1>
    </div>
    <div class="user-info">
        <div class="notification-icon" style="position: relative;">
            <i class="fas fa-bell"></i>
            <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
        </div>
        <span>Welcome, donlj</span>
        <img src="https://ui-avatars.com/api/?name=donlj&background=random" alt="User Avatar">
    </div>
</header>

<nav>
    <div class="nav-container">
        <div class="nav-links">
            <a href="admin-dashboard.html">Home</a>
            <a href="admin-dashboard.html#ambulances">Ambulances</a>
            <a href="notifications.html" class="active">Notifications</a>
            <a href="#">Reports</a>
            <a href="#">Settings</a>
        </div>
    </div>
</nav>

<div class="main-container">
    <div id="alertBox" class="alert"></div>
    <div class="notifications-wrapper">
        <div class="notifications-header">
            <h2>Recent Notifications</h2>
            <div class="date">
                <i class="fas fa-calendar"></i>
                <span id="current-date">2025-03-16 15:43:22</span>
            </div>
        </div>
        
        <div id="notificationsList" class="notifications-container">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading notifications...</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Ambulances -->
<div id="ambulanceModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span id="modalTitle">Available Ambulances</span>
            <button class="close-btn" onclick="closeModal()">Close</button>
        </div>
        <div id="ambulanceList" class="ambulance-list-modal"></div>
        <div id="map-container">
            <div id="map"></div>
            <div id="mapLoading" class="map-loading" style="display: none;">
                <div class="spinner"></div>
                <p>Loading ambulance locations...</p>
            </div>
            <div id="patientInfoBox" class="patient-info-box" style="display: none;">
                <h4>Patient Location</h4>
                <p id="patientLocationInfo"></p>
            </div>
        </div>
        <div class="modal-actions">
            <button id="notifyAllBtn" class="btn btn-accent" style="display: none;">
                <i class="fas fa-broadcast-tower"></i> Notify All Ambulances
            </button>
        </div>
    </div>
</div>

<!-- Socket.io connection status indicator -->
<div class="socket-status">
    <div class="socket-indicator socket-disconnected" id="socketIndicator"></div>
    <span id="socketStatus">Connecting...</span>
</div>

<footer class="footer">
    <p>&copy; 2025 FastTrack Ambulance Management System. All rights reserved.</p>
    <p>Version 2.5.0 | Last updated: <span id="footer-date">2025-03-16 15:43:22</span></p>
</footer>

<script>
    // Global variables
    let map;
    let ambulanceMarkers = [];
    let patientMarker;
    let currentPatientLocation = '';
    let currentPatientCoordinates = null;
    let directionsService;
    let directionsRenderer;
    let acceptedAmbulanceId = null;
    let ambulanceUpdateInterval;
    let currentNotificationId = null;
    let socket;
    let unreadNotifications = 0;
    
    // Mapbox token
    mapboxgl.accessToken = 'pk.eyJ1IjoidG9tMjYxMSIsImEiOiJjbTdxOXpqcjEwbXp3MmlxeWx5c2c0Ymt1In0.IDbRSRluguViXa6h1_18qA';
    
    // Initialize the page
    window.addEventListener('load', function() {
        // Initialize notifications
        loadNotificationsFromStorage();
        
        // Setup socket simulation (in a real app, this would connect to a real server)
        simulateSocketConnection();
        
        // Check for new notifications from patient form submissions
        checkForNewNotifications();
        
        // Set up periodic checks for new notifications
        setInterval(checkForNewNotifications, 5000);
    });
    
    // Simulate Socket.io connection
    function simulateSocketConnection() {
        // In a real app, this would use actual Socket.io
        console.log('Simulating socket connection...');
        
        // Simulate successful connection after a delay
        setTimeout(() => {
            updateSocketStatus(true);
        }, 1000);
        
        // Listen for storage events (for demo purposes)
        window.addEventListener('storage', function(e) {
            if (e.key === 'notifications') {
                checkForNewNotifications(true);
            }
        });
    }
    
    // Update socket connection status indicator
    function updateSocketStatus(isConnected) {
        const indicator = document.getElementById('socketIndicator');
        const statusText = document.getElementById('socketStatus');
        
        if (isConnected) {
            indicator.className = 'socket-indicator socket-connected';
            statusText.textContent = 'Connected';
        } else {
            indicator.className = 'socket-indicator socket-disconnected';
            statusText.textContent = 'Disconnected';
        }
    }
    
    // Load notifications from localStorage
    function loadNotificationsFromStorage() {
        const notificationsList = document.getElementById("notificationsList");
        
        // Get notifications from localStorage
        let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
        
        // Clear notifications list
        notificationsList.innerHTML = '';
        
        if (notifications.length === 0) {
            // Show empty state
            notificationsList.innerHTML = `
                <div class="no-notifications">
                    <i class="fas fa-bell-slash"></i>
                    <p>No notifications found</p>
                    <p>You'll see notifications about patient requests and alerts here.</p>
                </div>
            `;
            return;
        }
        
        // Add notifications to the list
        notifications.forEach(notification => {
            addNotificationToList(notification);
        });
        
        // Add event listeners
        setupEventListeners();
    }
    
    // Add a notification to the list
    function addNotificationToList(notification) {
        const notificationsList = document.getElementById("notificationsList");
        
        // Extract patient info
        const name = notification.patientName || 'Unknown Patient';
        const age = notification.patientAge || '';
        const location = notification.patientLocation || 'Unknown Location';
        const notificationId = notification._id || Date.now().toString();
        
        // Check if ambulance is already assigned
        const isAssigned = notification.status === 'assigned' || notification.assignedAmbulance;
        const assignedAmbulance = notification.assignedAmbulance || {};
        
        // Create notification card
        const notificationCard = document.createElement('div');
        notificationCard.className = `notification-card ${isAssigned ? 'ambulance-accepted' : ''}`;
        notificationCard.dataset.id = notificationId;
        
        // Get status badge
        const statusBadge = getStatusBadge(notification.status || 'pending');
        
        // Store coordinates if available
        const coordinates = notification.coordinates ? 
            `data-lat="${notification.coordinates.lat}" data-lng="${notification.coordinates.lng}"` : '';
        
        // Add notification content
        notificationCard.innerHTML = `
            <h3>${name} ${statusBadge}</h3>
            <div class="notification-details">
                <p><strong>Age:</strong> ${age} years</p>
                <p><strong>Location:</strong> ${location}</p>
                <p class="timestamp">Received: ${formatTimeAgo(new Date(notification.timestamp || new Date()))}</p>
                ${notification.emergencyDetails ? 
                    `<p><strong>Emergency Details:</strong> ${notification.emergencyDetails}</p>` : ''}
                ${isAssigned ? 
                    `<p class="status"><i class="fas fa-check-circle" style="color: var(--secondary-color);"></i> <strong>Ambulance ${assignedAmbulance.name || 'assigned'}</strong></p>` : 
                    ''}
            </div>
            <div class="notification-actions">
                ${isAssigned ? 
                    `<button class="btn track-btn" data-location="${location}" data-name="${name}" data-id="${notificationId}" data-ambulance="${assignedAmbulance._id || ''}">
                        <i class="fas fa-location-arrow"></i> Track Ambulance
                    </button>` : 
                    `<button class="btn btn-accent assign-btn" data-location="${location}" data-name="${name}" data-id="${notificationId}" ${coordinates}>
                        <i class="fas fa-ambulance"></i> Assign Ambulance
                    </button>`
                }
                <button class="btn btn-outline" onclick="markAsRead('${notificationId}')">
                    <i class="fas fa-check"></i> Mark as Handled
                </button>
            </div>
        `;
        
        // Add to the top of the list
        if (notificationsList.querySelector('.no-notifications')) {
            notificationsList.innerHTML = '';
        }
        notificationsList.insertBefore(notificationCard, notificationsList.firstChild);
    }
    
    // Format time ago
    function formatTimeAgo(date) {
        const now = new Date();
        const diffInSeconds = Math.floor((now - date) / 1000);
        
        if (diffInSeconds < 60) {
            return 'Just now';
        }
        
        const diffInMinutes = Math.floor(diffInSeconds / 60);
        if (diffInMinutes < 60) {
            return `${diffInMinutes} minute${diffInMinutes > 1 ? 's' : ''} ago`;
        }
        
        const diffInHours = Math.floor(diffInMinutes / 60);
        if (diffInHours < 24) {
            return `${diffInHours} hour${diffInHours > 1 ? 's' : ''} ago`;
        }
        
        const diffInDays = Math.floor(diffInHours / 24);
        if (diffInDays < 30) {
            return `${diffInDays} day${diffInDays > 1 ? 's' : ''} ago`;
        }
        
        // For older dates, show the actual date
        return date.toLocaleDateString();
    }
    
    // Get status badge HTML
    function getStatusBadge(status) {
        let badgeClass = 'pending';
        let badgeText = 'Pending';
        
        switch(status) {
            case 'assigned':
                badgeClass = 'assigned';
                badgeText = 'Assigned';
                break;
            case 'completed':
                badgeClass = 'completed';
                badgeText = 'Completed';
                break;
            case 'notifying':
                badgeClass = 'notifying';
                badgeText = 'Notifying';
                break;
        }
        
        return `<span class="status-badge ${badgeClass}">${badgeText}</span>`;
    }
    
    // Setup event listeners for notification actions
    function setupEventListeners() {
        // Assign buttons
        const assignButtons = document.querySelectorAll(".assign-btn");
        assignButtons.forEach(button => {
            button.addEventListener("click", function() {
                const patientLocation = this.getAttribute("data-location");
                const patientName = this.getAttribute("data-name");
                const notificationId = this.getAttribute("data-id");
                
                // Get coordinates if available
                let coordinates = null;
                if (this.hasAttribute("data-lat") && this.hasAttribute("data-lng")) {
                    coordinates = {
                        lat: parseFloat(this.getAttribute("data-lat")),
                        lng: parseFloat(this.getAttribute("data-lng"))
                    };
                }
                
                // Open modal with ambulances
                openAmbulancesModal(patientLocation, patientName, notificationId, coordinates);
            });
        });
        
        // Track buttons
        const trackButtons = document.querySelectorAll(".track-btn");
        trackButtons.forEach(button => {
            button.addEventListener("click", function() {
                const patientLocation = this.getAttribute("data-location");
                const ambulanceId = this.getAttribute("data-ambulance");
                const notificationId = this.getAttribute("data-id");
                
                // Redirect to tracking page
                window.location.href = `ambulance-tracking.html?patient=${encodeURIComponent(patientLocation)}&ambulance=${ambulanceId}&id=${notificationId}`;
            });
        });
    }
    
    // Check for new notifications
    function checkForNewNotifications(skipAnimation = false) {
        // In a real app, this would make an API call to the server
        // For this demo, we'll check localStorage
        
        // Get current notifications list
        const currentList = document.querySelectorAll('.notification-card');
        const currentIds = Array.from(currentList).map(card => card.dataset.id);
        
        // Get notifications from localStorage
        const notifications = JSON.parse(localStorage.getItem('notifications')) || [];
        
        // Check for new notifications
        let hasNewNotifications = false;
        
        notifications.forEach(notification => {
            if (!currentIds.includes(notification._id)) {
                // New notification found
                addNotificationToList(notification);
                hasNewNotifications = true;
                
                // Increment notification count
                if (!skipAnimation) {
                    incrementNotificationCount();
                }
            }
        });
        
        if (hasNewNotifications) {
            // Re-add event listeners
            setupEventListeners();
            
            // Show alert for new notifications
            if (!skipAnimation) {
                showAlert('New patient request received', 'success');
            }
        }
    }
    
    // Increment notification count badge
    function incrementNotificationCount() {
        const notificationCount = document.getElementById('notificationCount');
        unreadNotifications++;
        notificationCount.textContent = unreadNotifications;
        notificationCount.style.display = 'flex';
    }
    
    // Reset notification count
    function resetNotificationCount() {
        const notificationCount = document.getElementById('notificationCount');
        unreadNotifications = 0;
        notificationCount.textContent = '0';
        notificationCount.style.display = 'none';
    }
    
    // Mark notification as read/handled
    function markAsRead(notificationId) {
        // Get current notifications
        let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
        
        // Update notification status
        notifications = notifications.filter(notification => notification._id !== notificationId);
        
        // Save updated notifications
        localStorage.setItem('notifications', JSON.stringify(notifications));
        
        // Remove from UI with animation
        const notificationCard = document.querySelector(`.notification-card[data-id="${notificationId}"]`);
        if (notificationCard) {
            notificationCard.style.opacity = '0';
            setTimeout(() => {
                notificationCard.remove();
                
                // If no notifications left, show empty state
                const notificationsList = document.getElementById("notificationsList");
                if (notificationsList.children.length === 0) {
                    notificationsList.innerHTML = `
                        <div class="no-notifications">
                            <i class="fas fa-bell-slash"></i>
                            <p>No notifications found</p>
                            <p>You'll see notifications about patient requests and alerts here.</p>
                        </div>
                    `;
                }
            }, 300);
        }
        
        // Show confirmation
        showAlert('Notification marked as handled', 'success');
    }
    
    // Open modal with available ambulances
    function openAmbulancesModal(patientLocation, patientName, notificationId, coordinates) {
        // Store current notification ID
        currentNotificationId = notificationId;
        
        // Store patient location
        currentPatientLocation = patientLocation;
        currentPatientCoordinates = coordinates;
        
        // Update modal title
        document.getElementById('modalTitle').textContent = `Available Ambulances Near ${patientName}`;
        
        // Show modal
        const modal = document.getElementById('ambulanceModal');
        modal.style.display = 'block';
        
        // Show loading state
        const ambulanceList = document.getElementById('ambulanceList');
        ambulanceList.innerHTML = `
            <div class="loading">
                <div class="spinner"></div>
                <p>Finding available ambulances...</p>
            </div>
        `;
        
        // Initialize map
        initMap();
        
        // Get available ambulances
        getAvailableAmbulances();
        
        // Show notify all button
        document.getElementById('notifyAllBtn').style.display = 'block';
        document.getElementById('notifyAllBtn').onclick = function() {
            notifyAllAmbulances(patientLocation, notificationId);
        };
    }
    
    // Close modal
    function closeModal() {
        const modal = document.getElementById('ambulanceModal');
        modal.style.display = 'none';
        
        // Clear map and patient info
        if (map) {
            ambulanceMarkers.forEach(marker => marker.remove());
            ambulanceMarkers = [];
            
            if (patientMarker) {
                patientMarker.remove();
                patientMarker = null;
            }
        }
        
        // Reset current notification ID
        currentNotificationId = null;
        currentPatientLocation = '';
        currentPatientCoordinates = null;
    }
    
    // Initialize map
    function initMap() {
        // Create map if it doesn't exist yet
        if (!map) {
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v12',
                zoom: 12,
                center: [-122.4194, 37.7749] // Default center (San Francisco)
            });
            
            // Add navigation controls
            map.addControl(new mapboxgl.NavigationControl(), 'top-right');
        }
        
        // Show loading overlay
        document.getElementById('mapLoading').style.display = 'flex';
        
        // When map is loaded or if already loaded
        if (map.loaded()) {
            onMapLoaded();
        } else {
            map.on('load', onMapLoaded);
        }
    }
    
    // Handle map loaded event
    function onMapLoaded() {
        // Hide loading overlay
        document.getElementById('mapLoading').style.display = 'none';
        
        // Add patient marker if coordinates are available
        if (currentPatientCoordinates) {
            addPatientMarker(currentPatientCoordinates.lat, currentPatientCoordinates.lng);
        } else {
            // Try to geocode patient location
            geocodePatientLocation(currentPatientLocation);
        }
    }
    
    // Geocode patient location
    function geocodePatientLocation(address) {
        // In a real app, you would use Mapbox Geocoding API here
        // For demo, we'll generate a random location near San Francisco
        
        // Generate semi-random coordinates based on address string
        const hash = address.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
        const lat = 37.7749 + (hash % 100) / 500; // Small offset from SF
        const lng = -122.4194 + (hash % 100) / 500;
        
        // Add patient marker
        addPatientMarker(lat, lng);
        
        // Store coordinates
        currentPatientCoordinates = { lat, lng };
    }
    
    // Add patient marker to map
    function addPatientMarker(lat, lng) {
        // Remove existing marker if any
        if (patientMarker) {
            patientMarker.remove();
        }
        
        // Create and add marker
        patientMarker = new mapboxgl.Marker({
            color: '#ef4444',
            scale: 0.8
        })
            .setLngLat([lng, lat])
            .addTo(map);
        
        // Update patient info box
        document.getElementById('patientInfoBox').style.display = 'block';
        document.getElementById('patientLocationInfo').textContent = currentPatientLocation;
        
        // Center map on patient location
        map.flyTo({
            center: [lng, lat],
            zoom: 13,
            essential: true
        });
    }
    
    // Get available ambulances
    function getAvailableAmbulances() {
        // In a real app, this would be an API call to get ambulances near the patient location
        // For demo purposes, we'll simulate some ambulances
        
        // Clear existing ambulance markers
        ambulanceMarkers.forEach(marker => marker.remove());
        ambulanceMarkers = [];
        
        // Generate random ambulances based on patient location
        setTimeout(() => {
            const ambulances = generateRandomAmbulances();
            
            // Update ambulance list
            updateAmbulanceList(ambulances);
            
            // Add ambulance markers to map
            if (currentPatientCoordinates) {
                addAmbulanceMarkers(ambulances);
            }
        }, 1000); // Simulate API delay
    }
    
    // Generate random ambulances
    function generateRandomAmbulances() {
        // In a real app, you would get this data from your backend
        const ambulances = [];
        const numAmbulances = Math.floor(Math.random() * 3) + 2; // 2-4 ambulances
        
        // Base coordinates (if we have patient coordinates, use those as a reference)
        const baseLat = currentPatientCoordinates ? currentPatientCoordinates.lat : 37.7749;
        const baseLng = currentPatientCoordinates ? currentPatientCoordinates.lng : -122.4194;
        
        for (let i = 1; i <= numAmbulances; i++) {
            // Generate random offset (within ~2 miles)
            const latOffset = (Math.random() - 0.5) * 0.04;
            const lngOffset = (Math.random() - 0.5) * 0.04;
            
            ambulances.push({
                _id: `AMB-${100 + i}`,
                name: `Ambulance ${100 + i}`,
                driver: `Driver ${i}`,
                status: 'Available',
                location: {
                    address: `${i} miles away`,
                    coordinates: {
                        lat: baseLat + latOffset,
                        lng: baseLng + lngOffset
                    }
                },
                lastUpdated: new Date().toISOString()
            });
        }
        
        return ambulances;
    }
    
    // Update ambulance list in modal
    function updateAmbulanceList(ambulances) {
        const ambulanceList = document.getElementById('ambulanceList');
        
        if (ambulances.length === 0) {
            ambulanceList.innerHTML = `
                <div class="no-notifications">
                    <i class="fas fa-times-circle"></i>
                    <p>No ambulances available in this area</p>
                </div>
            `;
            return;
        }
        
        ambulanceList.innerHTML = '';
        
        ambulances.forEach(ambulance => {
            const ambulanceCard = document.createElement('div');
            ambulanceCard.className = 'ambulance-card';
            
            ambulanceCard.innerHTML = `
                <div class="ambulance-info">
                    <h3>
                        <span class="status-indicator status-available"></span>
                        ${ambulance.name}
                    </h3>
                    <p>Driver: ${ambulance.driver}</p>
                    <p>Location: ${ambulance.location.address}</p>
                </div>
                <button class="notify-btn" data-ambulance-id="${ambulance._id}" data-ambulance-name="${ambulance.name}">
                    <i class="fas fa-bell"></i> Notify
                </button>
            `;
            
            ambulanceList.appendChild(ambulanceCard);
        });
        
        // Add event listeners for notify buttons
        const notifyButtons = document.querySelectorAll('.notify-btn');
        notifyButtons.forEach(button => {
            button.addEventListener('click', function() {
                const ambulanceId = this.getAttribute('data-ambulance-id');
                const ambulanceName = this.getAttribute('data-ambulance-name');
                notifyAmbulance(ambulanceId, ambulanceName);
            });
        });
    }
    
    // Add ambulance markers to map
    function addAmbulanceMarkers(ambulances) {
        ambulances.forEach(ambulance => {
            const { lat, lng } = ambulance.location.coordinates;
            
            // Create Mapbox marker
            const marker = new mapboxgl.Marker({
                color: '#2563eb',
                scale: 0.7
            })
                .setLngLat([lng, lat])
                .addTo(map);
            
            // Create popup
            const popup = new mapboxgl.Popup({ offset: 25 })
                .setHTML(`
                    <div style="padding: 10px; max-width: 200px;">
                        <h3 style="margin-bottom: 5px; font-size: 16px;">${ambulance.name}</h3>
                        <p style="margin: 0; font-size: 14px;">Driver: ${ambulance.driver}</p>
                        <p style="margin: 0; font-size: 14px;">Status: ${ambulance.status}</p>
                    </div>
                `);
            
            // Show popup on click
            marker.getElement().addEventListener('click', () => {
                popup.addTo(map);
                marker.setPopup(popup);
            });
            
            // Add to markers array
            ambulanceMarkers.push(marker);
        });
        
        // Fit bounds to include all markers
        if (patientMarker) {
            const bounds = new mapboxgl.LngLatBounds();
            
            // Add patient marker position
            bounds.extend(patientMarker.getLngLat());
            
            // Add ambulance markers
            ambulanceMarkers.forEach(marker => {
                bounds.extend(marker.getLngLat());
            });
            
            // Fit map to bounds
            map.fitBounds(bounds, { padding: 70, maxZoom: 13 });
        }
    }
    
    // Notify a specific ambulance
    function notifyAmbulance(ambulanceId, ambulanceName) {
        // In a real app, this would send a notification to the ambulance driver
        
        // Update notification status
        updateNotificationStatus(currentNotificationId, {
            status: 'assigned',
            assignedAmbulance: {
                _id: ambulanceId,
                name: ambulanceName
            }
        });
        
        // Show success alert
        showAlert(`${ambulanceName} has been notified and assigned to the patient`, 'success');
        
        // Close modal
        closeModal();
    }
    
    // Notify all ambulances in the area
    function notifyAllAmbulances(patientLocation, notificationId) {
        // In a real app, this would send notifications to all ambulances in the area
        
        // Update notification status
        updateNotificationStatus(notificationId, {
            status: 'notifying'
        });
        
        // Show loading state
        const notifyAllBtn = document.getElementById('notifyAllBtn');
        const originalText = notifyAllBtn.innerHTML;
        notifyAllBtn.disabled = true;
        notifyAllBtn.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; margin: 0;"></div> Notifying...';
        
        // Simulate notification process
        setTimeout(() => {
            // Show success message
            showAlert('All ambulances in the area have been notified', 'success');
            
            // Reset button
            notifyAllBtn.innerHTML = originalText;
            notifyAllBtn.disabled = false;
            
            // Close modal
            closeModal();
        }, 2000);
    }
    
    // Update notification status
    function updateNotificationStatus(notificationId, updates) {
        // Get current notifications
        let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
        
        // Find and update notification
        notifications = notifications.map(notification => {
            if (notification._id === notificationId) {
                return { ...notification, ...updates };
            }
            return notification;
        });
        
        // Save updated notifications
        localStorage.setItem('notifications', JSON.stringify(notifications));
        
        // Update UI
        loadNotificationsFromStorage();
    }
    
    // Show alert message
    function showAlert(message, type) {
        const alertBox = document.getElementById('alertBox');
        alertBox.textContent = message;
        alertBox.className = `alert alert-${type}`;
        alertBox.style.display = 'block';
        
        // Hide alert after a delay
        setTimeout(() => {
            alertBox.style.display = 'none';
        }, 5000);
    }
    
    // Update current date on the page
    document.getElementById('current-date').textContent = '2025-03-16 15:49:15';
    document.getElementById('footer-date').textContent = '2025-03-16 15:49:15';
</script>
</body>
</html>        